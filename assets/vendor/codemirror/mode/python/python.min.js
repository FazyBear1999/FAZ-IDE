(function (mod) {
	if (typeof exports === "object" && typeof module === "object") {
		mod(require("../../codemirror"));
	} else if (typeof define === "function" && define.amd) {
		define(["../../codemirror"], mod);
	} else {
		mod(CodeMirror);
	}
})(function (CodeMirror) {
	"use strict";

	function toLookup(words) {
		var out = Object.create(null);
		for (var i = 0; i < words.length; i += 1) {
			out[words[i]] = true;
		}
		return out;
	}

	var KEYWORDS = toLookup([
		"and", "as", "assert", "async", "await", "break", "case", "class", "continue", "def", "del",
		"elif", "else", "except", "finally", "for", "from", "global", "if", "import", "in", "is",
		"lambda", "match", "nonlocal", "not", "or", "pass", "raise", "return", "try", "while", "with", "yield"
	]);

	var ATOMS = toLookup(["True", "False", "None", "Ellipsis"]);

	var BUILTINS = toLookup([
		"abs", "aiter", "all", "anext", "any", "ascii", "bin", "bool", "breakpoint", "bytearray", "bytes", "callable",
		"chr", "classmethod", "complex", "dict", "dir", "divmod", "enumerate", "eval", "filter", "float", "format",
		"frozenset", "getattr", "hasattr", "hash", "hex", "id", "input", "int", "isinstance", "issubclass", "iter",
		"len", "list", "locals", "map", "max", "memoryview", "min", "next", "object", "oct", "open", "ord", "pow",
		"print", "property", "range", "repr", "reversed", "round", "set", "setattr", "slice", "sorted", "staticmethod",
		"str", "sum", "super", "tuple", "type", "vars", "zip"
	]);

	var SPECIALS = toLookup(["self", "cls"]);

	function tokenString(quote, triple) {
		return function (stream, state) {
			var escaped = false;
			var ch;
			while ((ch = stream.next()) != null) {
				if (ch === quote && !escaped) {
					if (triple) {
						if (stream.match(quote + quote, true)) {
							state.tokenize = tokenBase;
							break;
						}
					} else {
						state.tokenize = tokenBase;
						break;
					}
				}
				escaped = !escaped && ch === "\\";
			}
			return "string";
		};
	}

	function tokenBase(stream, state) {
		if (stream.sol()) {
			state.indent = stream.indentation();
		}

		if (stream.peek() === "#") {
			stream.skipToEnd();
			return "comment";
		}

		if (stream.match(/^[rRuUbBfF]{0,2}("""|''')/)) {
			var tripleQuote = stream.current().slice(-3, -2);
			state.tokenize = tokenString(tripleQuote, true);
			return "string";
		}

		if (stream.match(/^[rRuUbBfF]{0,2}"/)) {
			state.tokenize = tokenString('"', false);
			return "string";
		}

		if (stream.match(/^[rRuUbBfF]{0,2}'/)) {
			state.tokenize = tokenString("'", false);
			return "string";
		}

		if (stream.match(/^0[xX][0-9a-fA-F]+\b/)) return "number";
		if (stream.match(/^0[bB][01]+\b/)) return "number";
		if (stream.match(/^0[oO][0-7]+\b/)) return "number";
		if (stream.match(/^\d+(?:_\d+)*(?:\.\d+(?:_\d+)*)?(?:[eE][+-]?\d+)?[jJ]?\b/)) return "number";
		if (stream.match(/^\.\d+(?:_\d+)*(?:[eE][+-]?\d+)?[jJ]?\b/)) return "number";

		if (stream.match(/^@[A-Za-z_][\w]*/)) return "meta";

		if (stream.match(/^[(){}\[\]]/)) return "bracket";
		if (stream.match(/^[,.;:]/)) return "operator";
		if (stream.match(/^[+\-*\/%=<>!&|^~]+/)) return "operator";

		if (stream.match(/^[A-Za-z_][\w]*/)) {
			var word = stream.current();

			if (state.expectDefinitionName) {
				state.expectDefinitionName = false;
				return "def";
			}

			if (ATOMS[word]) return "atom";

			if (KEYWORDS[word]) {
				state.expectDefinitionName = word === "def" || word === "class";
				return "keyword";
			}

			if (SPECIALS[word]) return "variable-2";
			if (/^__[A-Za-z_][\w]*__$/.test(word)) return "variable-3";
			if (/^[A-Z][A-Z0-9_]+$/.test(word)) return "variable-3";

			if (BUILTINS[word]) return "builtin";

			return "variable";
		}

		stream.next();
		return null;
	}

	CodeMirror.defineMode("python", function () {
		return {
			startState: function () {
				return {
					tokenize: tokenBase,
					indent: 0,
					expectDefinitionName: false,
				};
			},
			token: function (stream, state) {
				if (stream.eatSpace()) return null;
				return state.tokenize(stream, state);
			},
			lineComment: "#",
			fold: "indent",
		};
	});

	CodeMirror.defineMIME("text/x-python", "python");
});